<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head><body><h1 id="Distribution_Tool_Documentation">Distribution Tool Documentation</h1><ol style="list-style: none;"><li><a href="#Distribution_Tool_Documentation">Distribution Tool Documentation</a><ol style="list-style: none;"><li><a href="#Description">Description</a><ol style="list-style: none;"><li><a href="#What_do_we_want">What do we want</a></li><li><a href="#Notes">Notes</a></li></ol></li><li><a href="#Packaging_Process">Packaging Process</a><ol style="list-style: none;"><li><a href="#Distribution_package_building">Distribution package building</a></li><li><a href="#Installation">Installation</a></li></ol></li><li><a href="#Makefile_API">Makefile API</a><ol style="list-style: none;"><li><a href="#Master_Makefile">Master Makefile</a><ol style="list-style: none;"><li><a href="#Packaging_process">Packaging process</a></li></ol></li><li><a href="#Module_Makefile">Module Makefile</a><ol style="list-style: none;"><li><a href="#Expected_output">Expected output</a></li><li><a href="#API_reference">API reference</a></li></ol></li></ol></li><li><a href="#Install_script_reference">Install script reference</a></li></ol></li></ol><h2 id="Description">Description</h2><h3 id="What_do_we_want">What do we want</h3><ul><li>A top makefile that:<ul><li>Calls "make package -f Makefile.dist" in subfolders (also called modules)</li><li>Packages all the resulting packages of each module in a single package</li><li>Creates an install script to be used when unpacked</li></ul></li></ul><ul><li>An install script:<ul><li>Unpacks all submodules' packages</li><li>Runs "make install -f Makefile.dist" in all unpacked submodules</li><li>Propagates a PREFIX variable containing the installation prefix</li></ul></li></ul><ul><li>The modules distribution makefiles:<ul><li>Contain a "dist" target doing the work</li><li>Can include a makefile provided by this utility for helping methods</li><li>Must produce in the module folder a modulename-....-xx.tar.gz</li><li>The tar.gz must unpack to folder named the same way as the provided</li><li>If the file name ends in -xx.tar.gz, the xx could be interpreted as a version name</li></ul></li></ul><ul><li>Helpers</li></ul><h3 id="Notes">Notes</h3><p>The make file used for the distribution process is called "Makefile.dist" to avoid conflict if a module already has
a standard Makefile in use for like Autotools </p><h2 id="Packaging_Process">Packaging Process</h2><p>Note: The variables references used in this part are detailed under "Makefile API"</p><h3 id="Distribution_package_building">Distribution package building</h3><ul><li>For each module in $(DIST_MODULES)<ul><li>Call make dist using one possible Makefile file (see Module Makefile part)</li><li>Look in module folder for the most recent tar.gz</li><li>Add  the found tarball to resulting distribution package</li></ul></li><li>The modules packages are added to the distribution under the following name:<ul><li>$(count)-tarball.tar.gz</li><li>Where $(count) is the index in the module list</li><li>This ensures that installation calls make install in the same order as the modules list</li><li>This is required if modules need other previous modules to be build before them</li></ul></li></ul><h3 id="Installation">Installation</h3><p>A common install script is packages during distribution building</p><h2 id="Makefile_API">Makefile API</h2><p>Here is how to use this dist tool</p><h3 id="Master_Makefile">Master Makefile</h3><p>The master makefile is the one on which the user calls "make something" and which starts packaging the modules
and create the distribution package.</p><p>It must contain the following definitions:</p><pre> ## Distribution description
 DIST_VERSION := x.x.x
 DIST_NAME := distributionName  ## Output will be $(DIST_NAME)-$(DIST_VERSION).run
 DIST_MODULES := module1 path/to/another/module  ## List of the folders containing a module
 include $(ODFI_MBUILD_HOME)/sw/makefile/Makefile.dist  ## Include the distribution tool here! Not Before!
</pre><h4 id="Packaging_process">Packaging process</h4><h3 id="Module_Makefile">Module Makefile</h3><p>The modules must implement in a makefile a "dist" target, responsible for packaging the required files
The Makefile can be named (in oder of preference chosen by the tool):</p><ul><li>Makefile.modulename.dist</li><li>Makefile.dist</li><li>Makefile</li></ul><p>It must contain the following definitions:</p><p>	 ## Distribution description</p><pre> 	 DIST_VERSION := x.x.x ## Optional (inherited from master if not defined)
</pre><p>	 include $(ODFI_MBUILD_HOME)/sw/makefile/Makefile.dist  ## Include the distribution tool here! Not Before!</p><h4 id="Expected_output">Expected output</h4><p>The user should produce a tar.gz package with the module content to be distributed.
The master makefile will look in the module folder for the most recently created tarball</p><p>The help with that, a small API provides convienient functions to:</p><ul><li>Create a package prepare directory</li><li>Copy files in it</li><li>Package the work directory outputing a: $(DIST_MODULE_NAME)-$(DIST_VERSION).tar.gz file</li></ul><h4 id="API_reference">API reference</h4><pre>* variable $(dist-module-work-dir)
</pre><pre>	This variable contains the name of the packaging work dir
</pre><pre>	Example:
</pre><pre>	  dist:
	  	echo "Work dir: $(dist-module-work-dir)"
</pre><pre>* function $(dist-module-prepare-work)
</pre><pre>  	This function cleans the $(dist-module-work-dir) folder and creates it so that user may start preparing the package.
</pre><p>	Example:</p><p>		dist:
			$(dist-module-prepare-work)
			echo "Now the $(dist-module-work-dir)" is available</p><ul><li>function $(dist-module-add,path/to/file(s)*)</li></ul><pre> This function copies the provided folder content or files to the work directory.
 It takes one argument that can be a wildcard thing:
</pre><pre> Example:
 		dist:
 			$(dist-module-prepare-work)
 			@$(call dist-module-add,*.c)
 			@$(call dist-module-add,folder anotherfolder FILE1 FILE2)
</pre><h2 id="Install_script_reference">Install script reference</h2><p>The distribution package is a seflextracting script.
It takes following parameters:</p><ul><li>-v </li></ul><pre> Per default, make is called in silent mode. This arguments disables the make silent mode
</pre><ul><li>--no-install</li></ul><pre> Only Unpacks the packages, don't run any install target
</pre><ul><li>--prefix=<a href="/path/to/install">/path/to/install</a></li></ul><pre> This value will be set to the $(PREFIX) environment variable, and serves as default installation path
 for "install" commands calls for example
</pre></body></html>